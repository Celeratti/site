<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/telamaquina.css">
  <title>Componentes</title>
  <link rel="shortcut icon" href="./assets/img/celeratti-mascote.png" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Great+Vibes&family=Poppins:wght@300&family=Raleway&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main>

    <div id="titulo">
      <h1 id="maquina_nome"></h1>
    </div>

    <a href="dashInicio.html">Voltar para a tela de máquinas</a>

    <div id="disco">
      <div class="" id="">
        <canvas id="myChartCanvasDisco"></canvas>
        <div class="bolinhaAlerta"></div>
      </div>
    
    </div>
    <div class="legendaDisco">
      <details>
        <summary>Legendas Disco</summary>
        <img src="img/Group 93tempmetricas.png" alt="">
        <p>O uso do Disco Aumentou 5% nessa semana, e entrou em estado critico</p>
      </details>
    </div>


    <div id="cpu">
      <div class="" id="divAlertaCPU">
        <canvas id="myChartCanvasCpu"></canvas>
        <div class="" id="bolinhaAlertaCPU"></div>
      </div>
    </div>
    <div class="legendaCpu">
      <details>
        <summary>Legendas CPU</summary>
        <img src="img/Group 94tempmetricas.png" alt="">
        <p>O uso da CPU Aumentou 5% nessa semana, e entrou em estado critico</p>
      </details>
    </div>

    <div id="rede">
      <canvas id="myChart3"></canvas>
      <div class="bolinhaAlerta3"></div>
    </div>
    <div class="legendaRede">
      <details>
        <summary>Legendas Rede</summary>
        <img src="img/Group 96tempmetricas.png" alt="">
        <p>O uso da Rede Aumentou 5% nessa semana, e entrou em estado critico</p>
      </details>
    </div>

    <div id="memoriaEmUso">
      <canvas id="myChartCanvasMemoria"></canvas>
      <div class="bolinhaAlerta2"></div>
    </div>
    <div class="legendaMemoriaEmUso">
      <details>
        <summary>Legendas Memoria</summary>
        <img src="img/Group 95tempmetricas.png" alt="">
        <p>O uso da Memoria RAM Aumentou 5% nessa semana, e entrou em estado critico</p>    
      </details>
    </div>  

  </main>

</body>

</html>


<script>

var params = window.location.search
const urlParams = new URLSearchParams(params);
const idMaquina = urlParams.get('idMaquina')
const nomeMaquina = urlParams.get('nomeMaquina')
maquina_nome.innerHTML = "ViaMobilidade | Máquina " + nomeMaquina;

window.onload = obterDadosGrafico();


  function obterDadosGrafico() {
    obterDadosDisco(idMaquina);
    obterDadosCpu(idMaquina);
    obterDadosMemoria(idMaquina)

  }

  function obterDadosCpu(idMaquina) {
    
    fetch(`/medidas/ultimas/cpu/${idMaquina}`, {cache: 'no-store'}).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGraficoCpu(resposta, idMaquina);
        });
      } else{
        console.error(`Nenhum dado encontrado ou erro na API`);
      }
    })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        });
  }

    function plotarGraficoCpu(resposta, idMaquina) {
        console.log(`iniciando plotagem do gráfico...`);

        let labels = [];

        let dados = {
        labels: labels,
        datasets: [{
          label: `Porcentagem de uso`,
          data: [],
          fill: false,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
        }]   
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)
        var divCpu = document.getElementById('divAlertaCPU')
        var divBolinhaCPU = document.getElementById('bolinhaAlertaCPU')
        for (i = 0;i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.cpu);
            if((resposta.lenght-1).cpu < 61.0 ){
              divBolinhaCPU.classList.toggle('bolinhaAlertaIdeal')
            }
            else if ((resposta.lenght-1).cpu > 64.9 && (resposta.lenght-1).cpu < 80) {
              divCpu.classList.toggle('divAlertaEmergente')
              divBolinhaCPU.classList.toggle('bolinhaAlertaEmergente')
            }else if((resposta.lenght-1).cpu > 79.9 && (resposta.lenght-1).cpu < 90){
              divCpu.classList.toggle('divAlertaCritico')
              divBolinhaCPU.classList.toggle('bolinhaAlertaCritico')
            }else{
              divCpu.classList.toggle('divAlertaUrgente')
              divBolinhaCPU.classList.toggle('bolinhaAlertaUrgente')
            }
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        let myChart = new Chart(
          document.getElementById(`myChartCanvasCpu`),
          config
        );

        setTimeout(() => atualizarGraficoCpu(idMaquina,dados,myChart),60000);
    }

    function atualizarGraficoCpu(idMaquina,dados,myChart) {
      
      fetch(`/medidas/tempo-real/cpu/${idMaquina}`, { cache: `no-store` }).then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {

            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico`);
            console.log(dados);

            if(novoRegistro[0].momento_grafico == dados.labels[dados.labels.lenght - 1]) {
              console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------") 
            } else{

              dados.labels.shift();
              dados.labels.push(novoRegistro[0].momento_grafico);

              dados.datasets[0].data.shift();
              dados.datasets[0].data.push(novoRegistro[0].cpu);

              myChart.update();
            }
            
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myChart),60000);

          });
        } else{
          console.error('Nenhum dado encontrado ou erro na API');
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina,dados,myChart),60000);
        }
      })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico ${error.message}`)
        })
    }

    //Graficos Disco

    function obterDadosDisco(idMaquina) {
    
    fetch(`/medidas/ultimas/disco/${idMaquina}`, {cache: 'no-store'}).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGraficoDisco(resposta, idMaquina);
        });
      } else{
        console.error(`Nenhum dado encontrado ou erro na API`);
      }
    })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        });
  }

    function plotarGraficoDisco(resposta, idMaquina) {
        console.log(`iniciando plotagem do gráfico...`);

        let labels = [];

        let dados = {
        labels: labels,
        datasets: [{
          label: `Porcentagem de uso`,
          data: [],
          fill: false,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
        }]   
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        for (i = 0;i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.disco);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        let myChart = new Chart(
          document.getElementById(`myChartCanvasDisco`),
          config
        );

        setTimeout(() => atualizarGraficoDisco(idMaquina,dados,myChart),60000);
    }

    function atualizarGraficoDisco(idMaquina,dados,myChart) {
      
      fetch(`/medidas/tempo-real/disco${idMaquina}`, { cache: `no-store` }).then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {

            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico`);
            console.log(dados);

            if(novoRegistro[0].momento_grafico == dados.labels[dados.labels.lenght - 1]) {
              console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------") 
            } else{

              dados.labels.shift();
              dados.labels.push(novoRegistro[0].momento_grafico);

              dados.datasets[0].data.shift();
              dados.datasets[0].data.push(novoRegistro[0].disco);

              myChart.update();
            }
            
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myChart),60000);

          });
        } else{
          console.error('Nenhum dado encontrado ou erro na API');
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina,dados,myChart),60000);
        }
      })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico ${error.message}`)
        })
    }

    //Graficos memória

    function obterDadosMemoria(idMaquina) {
    
    fetch(`/medidas/ultimas/memoria/${idMaquina}`, {cache: 'no-store'}).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGraficoMemoria(resposta, idMaquina);
        });
      } else{
        console.error(`Nenhum dado encontrado ou erro na API`);
      }
    })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        });
  }

  function plotarGraficoMemoria(resposta, idMaquina) {
        console.log(`iniciando plotagem do gráfico...`);

        let labels = [];

        let dados = {
        labels: labels,
        datasets: [{
          label: `Porcentagem de uso`,
          data: [],
          fill: false,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
        }]   
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        for (i = 0;i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.memoria);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        let myChart = new Chart(
          document.getElementById(`myChartCanvasMemoria`),
          config
        );

        setTimeout(() => atualizarGraficoMemoria(idMaquina,dados,myChart),60000);
    }

    function atualizarGraficoMemoria(idMaquina,dados,myChart) {
      
      fetch(`/medidas/tempo-real/memoria/${idMaquina}`, { cache: `no-store` }).then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {

            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico`);
            console.log(dados);

            if(novoRegistro[0].momento_grafico == dados.labels[dados.labels.lenght - 1]) {
              console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------") 
            } else{

              dados.labels.shift();
              dados.labels.push(novoRegistro[0].momento_grafico);

              dados.datasets[0].data.shift();
              dados.datasets[0].data.push(novoRegistro[0].memoria);

              myChart.update();
            }
            
            proximaAtualizacao = setTimeout(() => atualizarGraficoMemoria(idMaquina, dados, myChart),60000);

          });
        } else{
          console.error('Nenhum dado encontrado ou erro na API');
          proximaAtualizacao = setTimeout(() => atualizarGraficoMemoria(idMaquina,dados,myChart),60000);
        }
      })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico ${error.message}`)
        })
    }

</script>