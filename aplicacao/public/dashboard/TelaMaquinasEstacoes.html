<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Great+Vibes&family=Poppins:wght@300&family=Raleway&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/maquinasestacoes.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="shortcut icon" href="./assets/img/celeratti-mascote.png" type="image/x-icon">
  <title>Máquinas</title>
</head>
<body>
  <h1>Estacão - Vila Prudente | Máquinas</h1>

  <a id= "a1" href="dashInicio.html">Voltar para a tela de estações</a>

  <div class="legenda">
    <p>Ideal</p>
    <div class="bolinha1"></div>
    <p>Emergente</p>
    <div class="bolinha2"></div>
    <p>Crítico</p>
    <div class="bolinha3"></div>
    <p>Urgente</p>
    <div class="bolinha4"></div>
  </div>

  <div class="botoes">
    <button id="btn1" onclick="trocar()">1</button>
    <button id="btn2" onclick="trocar1()" style="display: none;">2</button>
</div>
<div class="graficos">
  <div id="tela1"> 

  </div>

  <div id="tela2" style="display: none;"></div>
  
</div>
  
</body>
</html>

<script>
  
var params = window.location.search
const urlParams = new URLSearchParams(params);
const idEstacao= urlParams.get('idEstacao')
console.log(idEstacao)
window.onload = obterDadosGrafico();

function obterDadosGrafico() {
  obterDadosEstacao(idEstacao)
}

//Estação 1

function obterDadosEstacao(idEstacao) {
    
    fetch(`/medidas/estacoes/maquinas/${idEstacao}`, {cache: 'no-store'}).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

          plotarGrafico(resposta);
        });
      } else{
        console.error(`Nenhum dado encontrado ou erro na API`);
      }
    }).catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        });
}

    function plotarGrafico(resposta) {
      var page1 = document.getElementById('tela1');

      var page2 = document.getElementById('tela2');

      tela1.innerHTML = "";

      tela2.innerHTML = "";

      if(resposta.length > 4){
        btn2.style.display = 'block';
      }

      for (let i = 0; i < resposta.length; i++) {

        if((i + 1) > 4){
          page1 = page2;
        }

        var num = Math.random()* 4; 

        var maquina = resposta[i];
        
        var ancoraMaquina = document.createElement('a');

        var bordaMaquina = document.createElement('div');
        
        var h3 = document.createElement('h3');

        var divMaquina = document.createElement('div');
        
        var bolinhaAlerta = document.createElement('div');

        var grafico = document.createElement('canvas');

        bordaMaquina.className = `borda${i + 1}`;

        num = Math.floor(num);

        num++;

        bolinhaAlerta.className = `bolinhaAlerta${num}`;

        h3.innerHTML = `${maquina.nomeIdentificador}`;

        divMaquina.className = `maquina${i + 1}`;

        grafico.id = `myChart${i + 1}`;

        ancoraMaquina.href = `TelaMaquina.html?idMaquina=${maquina.id}&&nomeMaquina=${maquina.nomeIdentificador}`

        divMaquina.appendChild(bolinhaAlerta);
        
        divMaquina.appendChild(grafico);

        bordaMaquina.appendChild(h3);

        bordaMaquina.appendChild(divMaquina);

        ancoraMaquina.appendChild(bordaMaquina);

        page1.appendChild(ancoraMaquina);

        let labels = [];

        let dados = {
          labels: ['RAM', 'Disco', 'CPU'],
        datasets: [{
          label: `Porcentagem de uso`,
          data: [],
          fill: false,
          backgroundColor: 'red',
          borderColor: 'rgb(255, 255, 192)',
          tension: 0.1
      }]
        }   

        dados.datasets[0].data.push(maquina.memoriaEmUso);
        dados.datasets[0].data.push(maquina.discoUso);
        dados.datasets[0].data.push(maquina.cpuUtilizacao);

            const config = {
            type: 'bar',
            data: dados,
        };

        let nomeVariavel = `myChart` + (i + 1);

        let valorVariavel = new Chart(
          document.getElementById(`myChart${i + 1}`),
          config
        );
      }
    }
      setTimeout(() => atualizarGraficoEstacao(idEstacao,dados,myChart),60000);
     


    function atualizarGraficoEstacao(idEstacao,dados,myChart) {
      
      fetch(`/tempo-real/maquinas/${idEstacao}`, { cache: `no-store` }).then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {

            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico`);
            console.log(dados);

            if(novoRegistro[0].data == dados.labels[dados.labels.lenght - 1]) {
              console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].estacao)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------") 
            } else{

              dados.data.shift();
              dados.datasets[0].data.push(maquina.memoriaEmUso);
              dados.datasets[0].data.push(maquina.discoUso);
              dados.datasets[0].data.push(maquina.cpuUtilizacao);


              myChart.update();
            }
            
            proximaAtualizacao = setTimeout(() => atualizarGraficoEstacao(idEstacao, dados, myChart),60000);

          });
        } else{
          console.error('Nenhum dado encontrado ou erro na API');
          proximaAtualizacao = setTimeout(() => atualizarGraficoEstacao(idEstacao,dados,myChart),60000);
        }
      })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico ${error.message}`)
        })
    }
</script>
<script src="telas.js"></script>